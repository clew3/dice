<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>D20 ‚Üí 200 ‚Ä¢ Two-Player Percent Game</title>
<style>
  :root{
    --bg:#0f172a;--panel:#0b1323;--card:#0b1220;--ink:#e5e7eb;--muted:#93adc6;
    --line:#1a2646;--accent:#38bdf8;--accent2:#22c55e;--warn:#f97316;--danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 30% -10%,#1f2937 0%,var(--bg) 40%,#090e1a 100%) fixed;
       color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
       display:grid;place-items:start center;padding:20px}
  .app{width:100%;max-width:680px;background:linear-gradient(180deg,#0c1426,#0a1020);
       border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4);overflow:hidden}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--panel);border-bottom:1px solid #1c2741}
  h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
  main{padding:16px;display:grid;gap:14px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .label{font-size:12px;color:#9aa4b2;letter-spacing:.3px;margin-bottom:6px}
  .big{font-size:32px;font-weight:900;letter-spacing:.3px}
  .sub{font-size:13px;color:var(--muted)}
  .btn{background:linear-gradient(180deg,#0ea5e9,#0284c7);color:#fff;border:none;border-radius:12px;padding:10px 14px;
       font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(56,189,248,.25);transition:transform .05s,filter .2s}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#0f172a;color:#cbd5e1;border:1px solid #233153;box-shadow:none}
  .btn.ghost{background:transparent;border:1px dashed #324061;color:#aab4c2}
  .btn.warn{background:linear-gradient(180deg,#f97316,#ea580c)}
  .scoreboard{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .player{position:relative;padding:12px;border-radius:12px;background:linear-gradient(180deg,#0b1220,#0a121f);
          border:1px solid #1a2340}
  .player.active{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(56,189,248,.2) inset}
  .pname{font-weight:800}
  .ptotal{font-size:28px;font-weight:900}
  .meta{font-size:12px;color:var(--muted)}
  .hud .stat{display:flex;align-items:baseline;gap:8px}
  .win{padding:10px;border-radius:10px;background:#0b1a10;border:1px solid #143a22;color:#c6f6d5}
  .fail{padding:10px;border-radius:10px;background:#2a0d0d;border:1px solid #4d1515;color:#fecaca}
  details.settings{background:#0a1222;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  summary{cursor:pointer;font-weight:800;color:#cbd5e1;list-style:none}
  summary::-webkit-details-marker{display:none}
  label{font-size:12px;color:#aab4c2;display:grid;gap:6px}
  input[type="number"],select{background:#0e162a;border:1px solid #1d2747;color:#e5e7eb;border-radius:10px;padding:8px}
  input[type="checkbox"]{transform:translateY(1px)}
  table{width:100%;border-collapse:collapse;font-size:12.5px}
  th,td{padding:8px 6px;border-bottom:1px solid #162144;text-align:right}
  th:first-child,td:first-child{text-align:left}
  tr:last-child td{border-bottom:none}
  .good{color:var(--accent2)} .bad{color:var(--danger)}
  /* Dice */
  .dicebox{display:flex;align-items:center;gap:10px}
  .die{width:48px;height:48px;border-radius:12px;border:1px solid #1d2b52;background:linear-gradient(180deg,#0f1a33,#0b1430);
       display:grid;place-items:center;color:#f8fafc;font-weight:900;font-size:20px;position:relative;
       box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .die.rolling{animation:shake .6s ease both}
  @keyframes shake{
    0%{transform:translate(0,0) rotate(0deg)} 
    20%{transform:translate(-2px,-2px) rotate(-10deg)} 
    40%{transform:translate(3px,1px) rotate(8deg)} 
    60%{transform:translate(-1px,3px) rotate(-6deg)} 
    80%{transform:translate(2px,-2px) rotate(4deg)} 
    100%{transform:translate(0,0) rotate(0deg)}
  }
  .percentTag{font-size:12px;color:var(--muted)}
  .turninfo{font-size:12px;color:var(--muted)}
  .log{background:#0a1222;border:1px solid var(--line);border-radius:12px;padding:10px;max-height:260px;overflow:auto}
  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Two-Player D20 Percent Game">
  <header>
    <div class="die" aria-hidden="true" style="width:28px;height:28px;font-size:14px;border-radius:8px">d20</div>
    <h1>D20 ‚Üí 200 ‚Ä¢ Two-Player Percent Game</h1>
  </header>

  <main>
    <div class="scoreboard">
      <div id="p0" class="player active">
        <div class="row" style="justify-content:space-between">
          <div class="pname">Player 1</div>
          <div class="meta">Target: <span id="target">200</span></div>
        </div>
        <div class="ptotal" id="score0">0</div>
        <div class="meta">This turn start: <span id="turnStart0">0</span></div>
      </div>
      <div id="p1" class="player">
        <div class="row" style="justify-content:space-between">
          <div class="pname">Player 2</div>
          <div class="meta">Target: <span id="target2">200</span></div>
        </div>
        <div class="ptotal" id="score1">0</div>
        <div class="meta">This turn start: <span id="turnStart1">0</span></div>
      </div>
    </div>

    <div class="card hud">
      <div class="row" style="justify-content:space-between">
        <div class="stat">
          <div class="dicebox">
            <div id="die" class="die">‚Äî</div>
            <div>
              <div class="label">Last Roll</div>
              <div class="big" id="lastRoll">‚Äî</div>
              <div class="percentTag" id="lastPct">¬±% on current score</div>
            </div>
          </div>
        </div>
        <div>
          <div class="label">Turn / Sub‚Äëroll</div>
          <div class="big"><span id="turnNum">1</span> ‚Ä¢ <span id="subRoll">1</span>/<span id="rollsPerTurn">5</span></div>
          <div class="turninfo" id="turnInfo">Player 1‚Äôs turn</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;gap:8px;">
        <button class="btn" id="rollBtn" aria-label="Roll D20 (Space/Enter)">üé≤ Roll</button>
        <button class="btn secondary" id="undoBtn" disabled>Undo</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
      </div>
    </div>

    <details class="settings">
      <summary>‚öôÔ∏è Settings</summary>
      <div class="grid-3" style="margin-top:8px;">
        <label>Target
          <input type="number" id="setTarget" min="1" step="1" value="200"/>
        </label>
        <label>Rolls per turn
          <input type="number" id="setRPT" min="1" max="10" step="1" value="5"/>
        </label>
        <label>Rounding
          <select id="rounding">
            <option value="nearest">Nearest integer</option>
            <option value="none">No rounding (2 decimals)</option>
            <option value="floor">Floor</option>
            <option value="ceil">Ceil</option>
          </select>
        </label>
      </div>
      <div class="grid-2" style="margin-top:8px;">
        <label>Percent magnitudes (fixed set)
          <input type="text" id="pctSet" value="0,10,20,30,40,50,60,70,80,90,100"/>
          <span class="sub">Comma‚Äëseparated (each between 0 and 100)</span>
        </label>
        <label>Decrease probability
          <select id="decayProb">
            <option value="0.5">50% (default)</option>
            <option value="0.4">40%</option>
            <option value="0.6">60%</option>
            <option value="0.3">30%</option>
            <option value="0.7">70%</option>
          </select>
          <span class="sub">Chance that the percent is a <strong>decrease</strong>.</span>
        </label>
      </div>
      <div class="grid-2" style="margin-top:8px;">
        <label class="row" style="align-items:center;gap:8px;">
          <input type="checkbox" id="penaltyEndsTurn"/>
          <span>Penalty (1 or 11) ends the turn immediately</span>
        </label>
        <label class="row" style="align-items:center;gap:8px;">
          <input type="checkbox" id="exactTarget"/>
          <span>Require exact target to win</span>
        </label>
      </div>
      <div class="sub" style="margin-top:8px;">
        Rules: After each roll, apply a random percent (from the set above) to the <strong>current score</strong>.  
        A <strong>decrease</strong> subtracts that percent of the current score; an <strong>increase</strong> adds it.
      </div>
    </details>

    <div class="log" aria-live="polite" aria-label="Turn log">
      <table>
        <thead>
        <tr><th>Turn</th><th>P</th><th>Sub</th><th>Roll</th><th>%</th><th>Œî</th><th>Total</th><th>Note</th></tr>
        </thead>
        <tbody id="logBody">
          <tr><td colspan="8" style="text-align:center;color:#8aa1bd;">No turns yet.</td></tr>
        </tbody>
      </table>
    </div>

    <div id="winBox" class="win" style="display:none;">üéâ Winner! Great job.</div>
    <div id="failBox" class="fail" style="display:none;">Keep going‚Äîtry to reach the target.</div>
  </main>
</div>

<script>
(() => {
  // ---------------- Utilities ----------------
  const $ = id => document.getElementById(id);
  const fmt = (n, d=2) => (Number.isInteger(n) ? n.toString() : n.toFixed(d));
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const choice = arr => arr[Math.floor(Math.random()*arr.length)];
  const roundBy = (v,mode)=>{
    if(mode==='none') return Math.round(v*100)/100;
    if(mode==='nearest') return Math.round(v);
    if(mode==='floor') return Math.floor(v);
    if(mode==='ceil') return Math.ceil(v);
    return v;
  };

  // ---------------- Sound (Web Audio, tiny) ----------------
  const Audio = {
    ctx: null,
    ensure(){ if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    blip(time=0, freq=700, dur=0.08, type='sine', gain=0.12){
      this.ensure();
      const ctx = this.ctx;
      const t = ctx.currentTime + time;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(gain, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      osc.connect(g).connect(ctx.destination);
      osc.start(t); osc.stop(t+dur+0.01);
    },
    roll(){
      // a quick cascade of blips to feel like a dice tumble
      for(let i=0;i<6;i++){
        const f = randInt(300,800);
        this.blip(i*0.05, f, 0.05, 'triangle', 0.07);
      }
    },
    penaltyHard(){ // for roll==1
      this.blip(0, 200, 0.12, 'square', 0.18);
      this.blip(0.12, 150, 0.18, 'square', 0.18);
    },
    penaltySoft(){ // for roll==11
      this.blip(0, 320, 0.10, 'sawtooth', 0.12);
      this.blip(0.10, 260, 0.12, 'sawtooth', 0.10);
    },
    win(){
      this.blip(0, 660, 0.12, 'sine', 0.16);
      this.blip(0.12, 880, 0.14, 'sine', 0.16);
      this.blip(0.26, 990, 0.18, 'sine', 0.14);
    }
  };

  // ---------------- State ----------------
  const state = {
    target: 200,
    rounding: 'nearest',
    rollsPerTurn: 5,
    penaltyEndsTurn: false,
    exactTarget: false,
    percentSet: [0,10,20,30,40,50,60,70,80,90,100],
    decreaseProb: 0.5, // chance that percent is a decrease
    players: [
      { name: 'Player 1', total: 0, turnStart: 0 },
      { name: 'Player 2', total: 0, turnStart: 0 }
    ],
    currentPlayer: 0,
    turnNumber: 1,
    subRoll: 1,
    history: [] // stack of {snapshot, logRow}
  };

  // ---------------- Elements ----------------
  const score0 = $('score0'), score1 = $('score1');
  const turnStart0 = $('turnStart0'), turnStart1 = $('turnStart1');
  const p0 = $('p0'), p1 = $('p1');
  const targetEl = $('target'), targetEl2 = $('target2');
  const dieEl = $('die'), lastRollEl = $('lastRoll'), lastPctEl = $('lastPct');
  const turnNumEl = $('turnNum'), subRollEl = $('subRoll'), rollsPerTurnEl = $('rollsPerTurn'), turnInfo = $('turnInfo');
  const rollBtn = $('rollBtn'), undoBtn = $('undoBtn'), resetBtn = $('resetBtn');
  const logBody = $('logBody');
  const winBox = $('winBox'), failBox = $('failBox');

  // Settings
  const setTarget = $('setTarget');
  const setRPT = $('setRPT');
  const roundingSel = $('rounding');
  const pctSetInput = $('pctSet');
  const decProbSel = $('decayProb');
  const penaltyEndsTurnCb = $('penaltyEndsTurn');
  const exactTargetCb = $('exactTarget');

  // ---------------- Rendering ----------------
  function renderScores(){
    score0.textContent = fmt(state.players[0].total);
    score1.textContent = fmt(state.players[1].total);
    turnStart0.textContent = fmt(state.players[0].turnStart);
    turnStart1.textContent = fmt(state.players[1].turnStart);
    targetEl.textContent = targetEl2.textContent = state.target;
    turnNumEl.textContent = state.turnNumber;
    subRollEl.textContent = state.subRoll;
    rollsPerTurnEl.textContent = state.rollsPerTurn;
    p0.classList.toggle('active', state.currentPlayer===0);
    p1.classList.toggle('active', state.currentPlayer===1);
    turnInfo.textContent = `${state.players[state.currentPlayer].name}‚Äôs turn`;
  }

  function clearLogIfEmpty(){
    if (logBody.children.length===1 && logBody.children[0].children.length===1){
      // initial placeholder row
      logBody.innerHTML = '';
    }
  }

  function appendLogRow(row){
    clearLogIfEmpty();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.turn}</td>
      <td>${row.player+1}</td>
      <td>${row.sub}</td>
      <td>${row.roll}</td>
      <td class="${row.pctSign==='-'?'bad':'good'}">${row.pctSign}${row.pct}%</td>
      <td class="${row.delta>=0?'good':'bad'}">${row.delta>=0?'+':''}${fmt(row.delta)}</td>
      <td>${fmt(row.total)}</td>
      <td>${row.note||''}</td>
    `;
    logBody.appendChild(tr);
  }

  function resetLog(){
    logBody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#8aa1bd;">No turns yet.</td></tr>`;
  }

  function setStatus(win){
    if (win){
      winBox.style.display='block'; failBox.style.display='none';
    } else {
      winBox.style.display='none'; failBox.style.display='block';
    }
  }

  // ---------------- Game Flow ----------------
  function startGame(){
    state.players[0].total = 0;
    state.players[1].total = 0;
    state.currentPlayer = 0;
    state.turnNumber = 1;
    state.subRoll = 1;
    state.players[0].turnStart = 0;
    state.players[1].turnStart = 0;
    state.history = [];
    lastRollEl.textContent = '‚Äî';
    lastPctEl.textContent = '¬±% on current score';
    dieEl.textContent = '‚Äî';
    setStatus(false);
    undoBtn.disabled = true;
    renderScores();
    resetLog();
  }

  function saveSnapshot(noteRow=null){
    const snapshot = JSON.parse(JSON.stringify({
      target: state.target,
      rounding: state.rounding,
      rollsPerTurn: state.rollsPerTurn,
      penaltyEndsTurn: state.penaltyEndsTurn,
      exactTarget: state.exactTarget,
      percentSet: state.percentSet,
      decreaseProb: state.decreaseProb,
      players: state.players,
      currentPlayer: state.currentPlayer,
      turnNumber: state.turnNumber,
      subRoll: state.subRoll
    }));
    state.history.push({ snapshot, noteRow });
    undoBtn.disabled = false;
  }

  function restoreSnapshot(){
    if (!state.history.length) return;
    const { snapshot } = state.history.pop();
    const s = snapshot;
    state.target = s.target;
    state.rounding = s.rounding;
    state.rollsPerTurn = s.rollsPerTurn;
    state.penaltyEndsTurn = s.penaltyEndsTurn;
    state.exactTarget = s.exactTarget;
    state.percentSet = s.percentSet;
    state.decreaseProb = s.decreaseProb;
    state.players = s.players;
    state.currentPlayer = s.currentPlayer;
    state.turnNumber = s.turnNumber;
    state.subRoll = s.subRoll;
    undoBtn.disabled = state.history.length===0;
    // Remove the last log row if it was added with this snapshot
    if (logBody.lastChild && logBody.children.length>0){
      logBody.removeChild(logBody.lastChild);
      if (!logBody.children.length) resetLog();
    }
    renderScores();
  }

  function nextPlayer(){
    state.currentPlayer = (state.currentPlayer+1)%2;
    state.subRoll = 1;
    state.turnNumber += (state.currentPlayer===0) ? 1 : 0;
    // mark new turn start for the next player
    state.players[state.currentPlayer].turnStart = state.players[state.currentPlayer].total;
    renderScores();
  }

  function checkWin(){
    const p = state.players[state.currentPlayer];
    if (state.exactTarget){
      return p.total === state.target;
    }
    return p.total >= state.target;
  }

  function parsePercentSet(text){
    const arr = text.split(',')
      .map(s => Number(s.trim()))
      .filter(n => Number.isFinite(n) && n>=0 && n<=100);
    return (arr.length ? Array.from(new Set(arr)) : [0,10,20,30,40,50,60,70,80,90,100]);
  }

  function rollOnce(){
    // Disable button briefly to avoid spam
    rollBtn.disabled = true;
    dieEl.classList.add('rolling');
    Audio.roll();
    setTimeout(()=>{ // end of animation
      dieEl.classList.remove('rolling');
      rollBtn.disabled = false;
    }, 600);

    // Save snapshot before mutating (for undo)
    saveSnapshot();

    // Actual roll
    const roll = randInt(1,20);
    dieEl.textContent = roll;
    lastRollEl.textContent = roll;

    const cp = state.currentPlayer;
    const player = state.players[cp];
    const before = player.total;
    let after = before;
    let pctMag = 0, pctSign = '+';
    let note = '';
    let delta = 0;

    if (roll === 1){
      // Reset ENTIRE score to 0; no percent applied
      player.total = 0;
      after = player.total;
      pctMag = 0; pctSign = '+';
      delta = after - before;
      note = 'Rolled 1 ‚Üí total reset to 0';
      lastPctEl.textContent = 'Penalty: reset to 0';
      Audio.penaltyHard();
      appendLogRow({turn:state.turnNumber, player:cp, sub:state.subRoll, roll, pct:0, pctSign:'+',
                    delta, total:after, note});
      stepAfterRoll({ penalty:true, endsTurnMaybe:true });
      return;
    }

    if (roll === 11){
      // Reset to this turn‚Äôs start; no percent applied
      player.total = player.turnStart;
      after = player.total;
      pctMag = 0; pctSign = '+';
      delta = after - before;
      note = `Rolled 11 ‚Üí reset to turn start (${fmt(player.turnStart)})`;
      lastPctEl.textContent = 'Penalty: reset to turn start';
      Audio.penaltySoft();
      appendLogRow({turn:state.turnNumber, player:cp, sub:state.subRoll, roll, pct:0, pctSign:'+',
                    delta, total:after, note});
      stepAfterRoll({ penalty:true, endsTurnMaybe:true });
      return;
    }

    // Normal roll: add the roll, then apply ¬±percent to CURRENT SCORE
    let tmp = before + roll;

    // choose percent magnitude from set, and sign by probability
    pctMag = choice(state.percentSet);
    const isDecrease = Math.random() < state.decreaseProb;
    pctSign = isDecrease ? '-' : '+';

    if (pctMag > 0){
      if (isDecrease){
        // subtract that percent FROM CURRENT SCORE
        tmp = tmp * (1 - pctMag/100);
      } else {
        tmp = tmp * (1 + pctMag/100);
      }
    }
    after = roundBy(tmp, state.rounding);
    player.total = after;
    delta = after - before;

    lastPctEl.textContent = `${pctSign}${pctMag}% applied to current score`;
    appendLogRow({
      turn: state.turnNumber, player: cp, sub: state.subRoll, roll,
      pct: pctMag, pctSign, delta, total: after, note
    });

    if (checkWin()){
      setStatus(true);
      rollBtn.disabled = true;
      Audio.win();
    } else {
      setStatus(false);
      stepAfterRoll({ penalty:false });
    }
  }

  function stepAfterRoll({ penalty, endsTurnMaybe=false }){
    if (penalty && state.penaltyEndsTurn){
      // pass turn immediately
      nextPlayer();
      return;
    }
    // normal sub-roll progression
    if (state.subRoll >= state.rollsPerTurn){
      nextPlayer();
    } else {
      state.subRoll += 1;
      renderScores();
    }
  }

  // ---------------- Wiring ----------------
  rollBtn.addEventListener('click', rollOnce);
  undoBtn.addEventListener('click', ()=>{
    restoreSnapshot();
    // Re-enable roll button unless someone already won
    if (!checkWin()) rollBtn.disabled = false;
  });
  resetBtn.addEventListener('click', ()=>{
    startGame();
    rollBtn.disabled = false;
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if (e.key===' '||e.key==='Enter') { e.preventDefault(); rollBtn.click(); }
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z') { e.preventDefault(); undoBtn.click(); }
  });

  // Settings live updates
  function applySettings(){
    state.target = Math.max(1, Math.floor(Number(setTarget.value||200)));
    state.rounding = roundingSel.value;
    state.rollsPerTurn = clamp(Math.floor(Number(setRPT.value||5)),1,10);
    state.percentSet = parsePercentSet(pctSetInput.value);
    state.decreaseProb = Number(decProbSel.value||0.5);
    state.penaltyEndsTurn = !!penaltyEndsTurnCb.checked;
    state.exactTarget = !!exactTargetCb.checked;
    rollsPerTurnEl.textContent = state.rollsPerTurn;
    targetEl.textContent = targetEl2.textContent = state.target;
  }
  [setTarget, roundingSel, setRPT, pctSetInput, decProbSel, penaltyEndsTurnCb, exactTargetCb]
    .forEach(el=>el.addEventListener('change', applySettings));

  // Initialize
  startGame();
  applySettings();
  // Ensure each player's turnStart is correct for the first turn
  state.players[state.currentPlayer].turnStart = 0;
  renderScores();
})();
</script>
</body>
</html>
